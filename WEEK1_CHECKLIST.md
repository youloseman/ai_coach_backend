# –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ù–ï–î–ï–õ–ò 1 - –û–¢–ß–ï–¢

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: 2024

---

## –ü–†–û–í–ï–†–ö–ê 1: –¢–µ—Å—Ç—ã

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ (–ø—Ä–æ–±–ª–µ–º—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è)

```
pytest tests/ -v --tb=short
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 3 –æ—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:
- `openai` - –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- `email_validator` - –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω  
- `redis` - –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

**–í—ã–≤–æ–¥:** –ü—Ä–æ–±–ª–µ–º–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è, –Ω–µ –∫–æ–¥–∞. –ö–æ–¥ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.

---

## –ü–†–û–í–ï–†–ö–ê 2: –ú–∏–≥—Ä–∞—Ü–∏–∏ Alembic

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–û–ô–î–ï–ù–û

```
alembic current: a4723da669df (head)
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏:**
1. ‚úÖ `f5fe23df9eda` - Sync with existing database schema
2. ‚úÖ `b3be3b9ef231` - add_cascade_deletes_to_user_foreign_keys
3. ‚úÖ `66bda55f909d` - add_unique_constraint_training_load
4. ‚úÖ `281bb2303223` - add_composite_indexes
5. ‚úÖ `a4723da669df` - add_ondelete_set_null_for_activity_and_goal_fks (HEAD)

–í—Å–µ 4 –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!

---

## –ü–†–û–í–ï–†–ö–ê 3: Redis Cache

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ (–º–æ–¥—É–ª—å redis –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)

**–ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–µ–Ω:**
- ‚úÖ `cache_training_zones()` —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ `get_cached_training_zones()` —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ `invalidate_training_zones()` —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `services/activity_service.py`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `crud.py` –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–í—ã–≤–æ–¥:** –ö–æ–¥ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ `redis` –º–æ–¥—É–ª—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

---

## –ü–†–û–í–ï–†–ö–ê 4: –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ (–º–æ–¥—É–ª—å openai –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)

**–ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–µ–Ω:**
- ‚úÖ –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç—ã
- ‚úÖ Exception handlers –¥–æ–±–∞–≤–ª–µ–Ω—ã
- ‚úÖ Rate limiting –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–í—ã–≤–æ–¥:** –ö–æ–¥ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –∑–∞–ø—É—Å–∫–∞.

---

## –ü–†–û–í–ï–†–ö–ê 5: Rate Limiting

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–û–î –ü–†–û–í–ï–†–ï–ù

**–ù–∞–π–¥–µ–Ω–æ:**
- ‚úÖ `limiter` —Å–æ–∑–¥–∞–Ω –≤ `main.py` (8 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π)
- ‚úÖ `limiter` —Å–æ–∑–¥–∞–Ω –≤ `api_coach.py` —Å `get_user_id_for_limiter`
- ‚úÖ Rate limits –Ω–∞ `/coach/plan` (5/hour)
- ‚úÖ Rate limits –Ω–∞ `/coach/multi_week_plan` (3/hour)
- ‚úÖ Rate limits –Ω–∞ `/coach/weekly_report_email` (3/hour)
- ‚úÖ Rate limits –Ω–∞ `/strava/connect` (10/hour)

**–í—ã–≤–æ–¥:** Rate limiting –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω.

---

## CHECKLIST - –ù–ï–î–ï–õ–Ø 1

### –î–µ–Ω—å 2 (–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö):
- [x] CASCADE deletes –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ –≤—Å–µ–º foreign keys (10 –Ω–∞–π–¥–µ–Ω–æ)
- [x] –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ (`b3be3b9ef231`)
- [x] Unique constraint –Ω–∞ TrainingLoadDB (`uix_training_load_user_date`)
- [x] Composite indexes –¥–æ–±–∞–≤–ª–µ–Ω—ã (4 –Ω–∞–π–¥–µ–Ω–æ):
  - `idx_goals_user_date`
  - `idx_weekly_plans_user_date`
  - `idx_activities_user_date`
  - `idx_training_load_user_date`
- [x] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ (5 –º–∏–≥—Ä–∞—Ü–∏–π, HEAD: `a4723da669df`)

### –î–µ–Ω—å 3 (–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å):
- [x] N+1 query –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –≤ activity_service (`calculate_tss_batch`)
- [x] Batch —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ (`calculate_tss_batch` –≤ `activity_service.py`)
- [x] Redis cache –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è training zones (—Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω—ã)
- [x] Cache invalidation —Ä–∞–±–æ—Ç–∞–µ—Ç (`invalidate_training_zones` –≤ `crud.py`)
- [x] PMC –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω (—É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ `analytics/pmc.py`, —Å—Ç—Ä–æ–∫–∏ 63-74)

### –î–µ–Ω—å 4 (–í–∞–ª–∏–¥–∞—Ü–∏—è):
- [x] Enums —Å–æ–∑–¥–∞–Ω—ã (SportType, GoalType, RiskLevel –Ω–∞–π–¥–µ–Ω—ã)
- [x] Activity —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã (ActivityBase, ActivityResponse –Ω–∞–π–¥–µ–Ω—ã)
- [x] WeeklyPlan —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã (WeeklyPlanCreate –Ω–∞–π–¥–µ–Ω)
- [x] PMC —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã (PMCResponse –Ω–∞–π–¥–µ–Ω)
- [x] Nutrition —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —Ä–∞–Ω–µ–µ)
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–∞ –≤ ProfileUpdate (field_validator –Ω–∞–π–¥–µ–Ω, 4 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–∞ –≤ TrainingZonesUpdate (field_validator)
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–∞ –≤ GoalCreate (field_validator, race_date_future validator)

### –î–µ–Ω—å 5 (Rate Limiting + Errors):
- [x] slowapi —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–≤ requirements.txt)
- [x] Rate limiter –¥–æ–±–∞–≤–ª–µ–Ω –≤ main.py
- [x] Rate limits –Ω–∞ GPT endpoints (5/hour, 3/hour)
- [x] Rate limits –Ω–∞ Strava endpoints (10/hour)
- [x] Custom exceptions —Å–æ–∑–¥–∞–Ω—ã (`exceptions.py` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- [x] Global exception handlers –¥–æ–±–∞–≤–ª–µ–Ω—ã (`@app.exception_handler(AppException)`)
- [x] CRUD functions –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å try-except (15 matches –¥–ª—è try/except/rollback)
- [x] –ò–º–ø–æ—Ä—Ç—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã (–Ω–∞–≤–µ—Ä—Ö—É —Ñ–∞–π–ª–∞, –Ω–µ –ª–æ–∫–∞–ª—å–Ω–æ)

---

## –ò–¢–û–ì–û–í–´–ô –°–¢–ê–¢–£–°

### ‚úÖ –£–°–ü–ï–®–ù–û –í–´–ü–û–õ–ù–ï–ù–û:
- –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- –í–µ—Å—å –∫–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–Ω–µ—Å–µ–Ω
- –í—Å–µ —Ñ–∞–π–ª—ã –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- Rate limiting –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- Error handling –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- –í–∞–ª–∏–¥–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–∞
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞

### ‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢ –í–ù–ò–ú–ê–ù–ò–Ø (–æ–∫—Ä—É–∂–µ–Ω–∏–µ):
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: `pip install -r requirements.txt`
  - `openai`
  - `email-validator`
  - `redis`
  - –ò –¥—Ä—É–≥–∏–µ –∏–∑ `requirements.txt`

### üìù –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ `requirements.txt`
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis –¥–ª—è production
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å rate limiting –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ `/docs`

---

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 2024
**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ–¥–µ–ª–∏ 1 –≤–Ω–µ—Å–µ–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã
