# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ AI Triathlon Coach

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
4. [Backend –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#backend-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
5. [Frontend –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#frontend-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
6. [–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è](#–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è-–∏-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
7. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
8. [–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö](#–ø–æ—Ç–æ–∫–∏-–¥–∞–Ω–Ω—ã—Ö)
9. [–î–µ–ø–ª–æ–π –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞](#–¥–µ–ø–ª–æ–π-–∏-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
10. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

---

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

**AI Triathlon Coach** ‚Äî —ç—Ç–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ AI-—Ç—Ä–µ–Ω–µ—Ä–∞ —Ç—Ä–∏–∞—Ç–ª–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä–æ–µ:

- –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–º –∞—Ç–ª–µ—Ç–∞ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–º–∏ —Ü–µ–ª—è–º–∏
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å–æ Strava –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –∑–æ–Ω—ã –∏ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –ø–ª–∞–Ω—ã —Å –ø–æ–º–æ—â—å—é GPT
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Ä–∏—Å–∫ —Ç—Ä–∞–≤–º
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–∫–ª–∏–µ–Ω—Ç-—Å–µ—Ä–≤–µ—Ä–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞:
- **Backend**: FastAPI REST API (Python)
- **Frontend**: Next.js SPA (TypeScript/React)
- **Database**: SQLite (dev) / PostgreSQL (prod)
- **External APIs**: Strava OAuth2, OpenAI GPT

---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend

| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|--------|------------|
| Python | 3.11+ | –û—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ |
| FastAPI | Latest | Web framework |
| SQLAlchemy | Latest | ORM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î |
| Alembic | Latest | –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î |
| Pydantic | Latest | –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö |
| JWT (python-jose) | Latest | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è |
| HTTPX | Latest | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã |
| OpenAI | Latest | GPT –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è |

### Frontend

| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|--------|------------|
| Next.js | 16.0.5 | React framework |
| React | Latest | UI –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ |
| TypeScript | Latest | –¢–∏–ø–∏–∑–∞—Ü–∏—è |
| Tailwind CSS | Latest | –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è |
| React Query | Latest | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ |
| Axios | Latest | HTTP –∫–ª–∏–µ–Ω—Ç |

### Database

- **Development**: SQLite (`triathlon_coach.db`)
- **Production**: PostgreSQL (Railway)

### Deployment

- **Platform**: Railway
- **Build System**: Nixpacks
- **CI/CD**: GitHub Actions

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **SQLAlchemy ORM** —Å –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏. –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:

#### 1. `users` ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

```python
class User(Base):
    id: int (PK)
    email: str (unique)
    username: str (unique)
    hashed_password: str
    full_name: str (optional)
    
    # Strava –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
    strava_athlete_id: str (optional)
    strava_access_token: str (optional)
    strava_refresh_token: str (optional)
    strava_token_expires_at: datetime (optional)
    
    # –°—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞
    is_active: bool
    is_verified: bool
    created_at: datetime
    updated_at: datetime
```

**–°–≤—è–∑–∏:**
- `One-to-One` —Å `AthleteProfileDB`
- `One-to-Many` —Å `GoalDB`, `WeeklyPlanDB`, `ActivityDB`

#### 2. `athlete_profiles` ‚Äî –ü—Ä–æ—Ñ–∏–ª—å –∞—Ç–ª–µ—Ç–∞

```python
class AthleteProfileDB(Base):
    id: int (PK)
    user_id: int (FK ‚Üí users.id, unique)
    
    # –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    age: int (optional)
    gender: str (optional)
    weight_kg: float (optional)
    height_cm: float (optional)
    years_of_experience: int
    
    # –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –∑–æ–Ω—ã (JSON)
    training_zones_run: JSON
    training_zones_bike: JSON
    training_zones_swim: JSON
    zones_last_updated: date
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    auto_weeks_analyzed: int
    auto_current_weekly_streak_weeks: int
    auto_longest_weekly_streak_weeks: int
    auto_avg_hours_last_12_weeks: float
    auto_avg_hours_last_52_weeks: float
    auto_discipline_hours_per_week: JSON
    
    # –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
    primary_discipline: str (run/bike/swim)
    preferred_training_days: JSON (array)
    available_hours_per_week: float
```

#### 3. `goals` ‚Äî –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ —Ü–µ–ª–∏

```python
class GoalDB(Base):
    id: int (PK)
    user_id: int (FK ‚Üí users.id)
    
    goal_type: str (SPRINT, OLYMPIC, HALF_IRONMAN, IRONMAN, etc.)
    target_time: str (optional, "4:30" –∏–ª–∏ "sub 5:00")
    race_date: date
    race_name: str (optional)
    race_location: str (optional)
    
    is_primary: bool (—Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ primary —Ü–µ–ª—å)
    is_completed: bool
```

#### 4. `weekly_plans` ‚Äî –ù–µ–¥–µ–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã

```python
class WeeklyPlanDB(Base):
    id: int (PK)
    user_id: int (FK ‚Üí users.id)
    goal_id: int (FK ‚Üí goals.id, optional)
    
    week_start_date: date
    week_number: int (–Ω–µ–¥–µ–ª—è –≤ —Ü–∏–∫–ª–µ)
    plan_json: JSON (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç GPT)
    
    available_hours: float
    coach_notes: text
    
    completed: bool
    completion_rate: float (0-100%)
```

#### 5. `activities` ‚Äî –ö—ç—à –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π Strava

```python
class ActivityDB(Base):
    id: int (PK)
    user_id: int (FK ‚Üí users.id)
    strava_activity_id: int (unique)
    
    activity_type: str
    name: str
    distance_meters: float
    moving_time_seconds: int
    elapsed_time_seconds: int
    total_elevation_gain: float
    start_date: datetime
    
    # –î–µ—Ç–∞–ª–∏ (JSON)
    details_json: JSON
    
    cached_at: datetime
```

#### 6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

- `segments` ‚Äî –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã Strava
- `segment_efforts` ‚Äî –£—Å–∏–ª–∏—è –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç–∞—Ö
- `personal_records` ‚Äî –õ–∏—á–Ω—ã–µ —Ä–µ–∫–æ—Ä–¥—ã
- `injury_risks` ‚Äî –ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–∞ —Ç—Ä–∞–≤–º
- `nutrition_targets` ‚Äî –¶–µ–ª–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é
- `nutrition_plans` ‚Äî –ü–ª–∞–Ω—ã –ø–∏—Ç–∞–Ω–∏—è

### –ú–∏–≥—Ä–∞—Ü–∏–∏

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Alembic** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏:

```bash
# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic revision --autogenerate -m "description"

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head
```

–§–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `alembic/versions/`.

---

## Backend –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π

```
ai_coach_backend/
‚îú‚îÄ‚îÄ main.py                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, FastAPI app, CORS, rate limiting
‚îú‚îÄ‚îÄ database.py            # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î, SessionLocal, init_db
‚îú‚îÄ‚îÄ models.py               # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îú‚îÄ‚îÄ schemas.py              # Pydantic —Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ crud.py                 # CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î
‚îú‚îÄ‚îÄ auth.py                 # JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ
‚îú‚îÄ‚îÄ api_auth.py             # –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã: /auth/register, /auth/login, /auth/me
‚îú‚îÄ‚îÄ api_user.py             # –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã: /profile, /goals
‚îú‚îÄ‚îÄ api_coach.py            # –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã: /coach/* (–ø–ª–∞–Ω—ã, –∑–æ–Ω—ã, –ø—Ä–æ—Ñ–∏–ª—å)
‚îú‚îÄ‚îÄ api_segments.py         # –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã: /segments/* (—Å–µ–≥–º–µ–Ω—Ç—ã, PR)
‚îú‚îÄ‚îÄ api_nutrition.py        # –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã: /nutrition/* (—Ü–µ–ª–∏, –ø–ª–∞–Ω—ã)
‚îÇ
‚îú‚îÄ‚îÄ strava_client.py        # –ö–ª–∏–µ–Ω—Ç Strava API (OAuth, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
‚îú‚îÄ‚îÄ strava_auth.py         # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Strava —Ç–æ–∫–µ–Ω–æ–≤
‚îú‚îÄ‚îÄ segment_sync.py         # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –∏ PR
‚îÇ
‚îú‚îÄ‚îÄ coach.py                # –õ–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–æ–≤ (GPT)
‚îú‚îÄ‚îÄ athlete_profile.py      # JSON –ø—Ä–æ—Ñ–∏–ª—å –∞—Ç–ª–µ—Ç–∞ (legacy)
‚îú‚îÄ‚îÄ training_zones.py       # –†–∞—Å—á–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –∑–æ–Ω
‚îú‚îÄ‚îÄ performance_predictions.py  # –ü—Ä–æ–≥–Ω–æ–∑—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
‚îú‚îÄ‚îÄ fatigue_detection.py    # –ê–Ω–∞–ª–∏–∑ —É—Å—Ç–∞–ª–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ analytics.py            # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏, —Ñ–æ—Ä–º—ã
‚îú‚îÄ‚îÄ progress.py             # –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
‚îÇ
‚îú‚îÄ‚îÄ config.py               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ dependencies.py         # FastAPI dependencies
‚îú‚îÄ‚îÄ utils.py                # –£—Ç–∏–ª–∏—Ç—ã
‚îî‚îÄ‚îÄ requirements.txt        # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. `main.py` ‚Äî FastAPI Application

```python
app = FastAPI(title="AI Triathlon Coach API")

# CORS middleware (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤—ã–º)
app.add_middleware(CORSMiddleware, ...)

# Rate limiting
limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤
app.include_router(auth_router, prefix="/auth", tags=["auth"])
app.include_router(user_router, prefix="", tags=["user"])
app.include_router(coach_router, prefix="/coach", tags=["coach"])
app.include_router(segments_router, prefix="/segments", tags=["segments"])
app.include_router(nutrition_router, prefix="/nutrition", tags=["nutrition"])

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
@app.on_event("startup")
async def startup():
    init_db()
```

**–ö–ª—é—á–µ–≤—ã–µ middleware:**
- **CORS**: –†–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- **Rate Limiting**: –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- **Authentication**: JWT —Ç–æ–∫–µ–Ω—ã —á–µ—Ä–µ–∑ `get_current_user` dependency

#### 2. `auth.py` ‚Äî JWT –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

```python
# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):
    to_encode = data.copy()
    expire = datetime.utcnow() + (expires_delta or timedelta(hours=24))
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm="HS256")
    return encoded_jwt

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: Session = Depends(get_db)
) -> models.User:
    credentials_exception = HTTPException(
        status_code=401,
        detail="Could not validate credentials"
    )
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=["HS256"])
        user_id: int = payload.get("sub")
        if user_id is None:
            raise credentials_exception
    except JWTError:
        raise credentials_exception
    
    user = db.query(models.User).filter(models.User.id == user_id).first()
    if user is None:
        raise credentials_exception
    return user
```

#### 3. `strava_client.py` ‚Äî Strava API Client

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async def get_user_tokens(user_id: int, db: Session) -> dict:
    """–ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –∏–∑ –ë–î, –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ—Å–ª–∏ –∏—Å—Ç–µ–∫–ª–∏"""
    
# –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
async def fetch_activities_last_n_weeks_for_user(
    user_id: int,
    db: Session,
    weeks: int = 12
) -> list[dict]:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –Ω–µ–¥–µ–ª—å"""
    
# –û–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω—ã
async def exchange_code_for_token(code: str) -> dict:
    """OAuth2: –æ–±–º–µ–Ω authorization code –Ω–∞ access/refresh —Ç–æ–∫–µ–Ω—ã"""
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–µ–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –≤ –ë–î
- Graceful handling –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Strava

#### 4. `coach.py` ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–æ–≤

```python
async def run_weekly_plan(
    goal: GoalInput,
    start_date: date,
    available_hours: float,
    activities_history: list[dict]
) -> dict:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω —á–µ—Ä–µ–∑ GPT"""
    
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø—Ä–æ—Ñ–∏–ª—å, —Ü–µ–ª–∏, –∏—Å—Ç–æ—Ä–∏—è)
    # 2. –í—ã–∑–æ–≤ OpenAI API —Å –ø—Ä–æ–º–ø—Ç–æ–º
    # 3. –ü–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç–≤–µ—Ç–∞
    # 4. –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–ª–∞–Ω–∞
    # 5. –í–æ–∑–≤—Ä–∞—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∞
```

**–ü—Ä–æ–º–ø—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤:** `prompts/trainer_prompt.py`

#### 5. `api_coach.py` ‚Äî Coach Endpoints

**–û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:**

- `POST /coach/plan` ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞
- `GET /coach/weekly_plan` ‚Äî –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–∞–Ω–∞
- `POST /coach/profile/auto_from_history` ‚Äî –ê–≤—Ç–æ-–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ Strava
- `POST /zones/calculate` ‚Äî –†–∞—Å—á–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –∑–æ–Ω (run/bike/swim)
- `GET /coach/profile` ‚Äî –ü—Ä–æ—Ñ–∏–ª—å –∫–æ—É—á–∞ (JSON)

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

Backend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **graceful degradation**:

```python
try:
    activities = await fetch_activities_last_n_weeks_for_user(user_id, db, weeks=12)
    if not activities:
        return {
            "status": "no_data",
            "message": "Connect to Strava to see activities"
        }
except Exception as e:
    logger.error("error_fetching_activities", error=str(e))
    return {
        "status": "error",
        "message": "Unable to fetch activities"
    }
```

---

## Frontend –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
frontend/
‚îú‚îÄ‚îÄ app/                    # Next.js App Router
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx         # Root layout
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx           # –ì–ª–∞–≤–Ω–∞—è (—Ä–æ—É—Ç–∏–Ω–≥)
‚îÇ   ‚îú‚îÄ‚îÄ providers.tsx      # React Query provider
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ login/             # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ register/          # –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ onboarding/       # –û–Ω–±–æ—Ä–¥–∏–Ω–≥ (–ø—Ä–æ—Ñ–∏–ª—å + —Ü–µ–ª—å)
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/         # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∞—à–±–æ—Ä–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ coach/             # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø—Ä–æ—Ñ–∏–ª—å, Strava)
‚îÇ   ‚îú‚îÄ‚îÄ goals/             # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–ª—è–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ plans/             # –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ø–ª–∞–Ω–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ segments/          # –°–µ–≥–º–µ–Ω—Ç—ã Strava
‚îÇ   ‚îî‚îÄ‚îÄ nutrition/         # –ü–∏—Ç–∞–Ω–∏–µ (—Ü–µ–ª–∏, –ø–ª–∞–Ω—ã)
‚îÇ
‚îú‚îÄ‚îÄ components/            # React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ Header.tsx         # –ù–∞–≤–∏–≥–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ FormStatusCard.tsx # –ö–∞—Ä—Ç–æ—á–∫–∞ —Ñ–æ—Ä–º—ã (CTL/ATL/TSB)
‚îÇ   ‚îú‚îÄ‚îÄ InjuryRisk.tsx     # –†–∏—Å–∫ —Ç—Ä–∞–≤–º
‚îÇ   ‚îú‚îÄ‚îÄ WeeklyPlanCompact.tsx  # –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –ø–ª–∞–Ω
‚îÇ   ‚îú‚îÄ‚îÄ SegmentsSummary.tsx     # –°–≤–æ–¥–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ NutritionQuickStats.tsx # –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∏—Ç–∞–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ api.ts            # Axios –∫–ª–∏–µ–Ω—Ç, API –º–µ—Ç–æ–¥—ã
‚îÇ   ‚îî‚îÄ‚îÄ auth.ts            # –†–∞–±–æ—Ç–∞ —Å localStorage
‚îÇ
‚îî‚îÄ‚îÄ types/
    ‚îî‚îÄ‚îÄ index.ts           # TypeScript —Ç–∏–ø—ã
```

### Next.js App Router

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **App Router** (Next.js 13+):

- **Server Components** –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- **Client Components** —Å `"use client"` –¥–∏—Ä–µ–∫—Ç–∏–≤–æ–π
- **Route Handlers** –¥–ª—è API routes (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º

#### React Query

```typescript
// lib/api.ts
export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5, // 5 –º–∏–Ω—É—Ç
      gcTime: 1000 * 60 * 30,    // 30 –º–∏–Ω—É—Ç
      refetchOnWindowFocus: false,
      retry: 1,
    },
  },
});
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```typescript
// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
const { data, isLoading, isError } = useQuery({
  queryKey: ['weeklyPlan'],
  queryFn: () => coachAPI.getWeeklyPlan(),
});
```

#### Local Storage

JWT —Ç–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `localStorage`:

```typescript
// lib/auth.ts
export function setAuthToken(token: string, user: User) {
  localStorage.setItem('token', token);
  localStorage.setItem('user', JSON.stringify(user));
}
```

### API Client (`lib/api.ts`)

**Axios instance —Å interceptors:**

```typescript
const api = axios.create({
  baseURL: API_URL,
  headers: { 'Content-Type': 'application/json' },
});

// Request interceptor: –¥–æ–±–∞–≤–ª—è–µ—Ç JWT —Ç–æ–∫–µ–Ω
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// Response interceptor: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ /login
    }
    return Promise.reject(error);
  }
);
```

**API –º–µ—Ç–æ–¥—ã –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã –ø–æ –¥–æ–º–µ–Ω–∞–º:**

```typescript
export const authAPI = { register, login, getMe };
export const userAPI = { getProfile, updateProfile, getGoals, createGoal };
export const coachAPI = { getProfile, generateWeeklyPlan, ... };
export const zonesAPI = { calculate };
export const weeklyPlanAPI = { getCurrent };
export const performanceAPI = { getInjuryRisks, getRecentSegmentPRs, ... };
export const nutritionAPI = { getTargets, updateTargets, ... };
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### –ü—Ä–∏–º–µ—Ä: `WeeklyPlanCompact.tsx`

```typescript
export function WeeklyPlanCompact() {
  const { data, isLoading, isError } = useQuery<WeeklyPlanResponse>({
    queryKey: ['weeklyPlanPreview'],
    queryFn: async () => {
      const res = await coachAPI.getWeeklyPlan();
      return res;
    },
  });

  // –†–µ–Ω–¥–µ—Ä –∫–æ–º–ø–∞–∫—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø–ª–∞–Ω–∞
  return (
    <div className="bg-slate-900/60 border border-slate-800 rounded-xl p-4">
      {/* ... */}
    </div>
  );
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:**
- –í—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å (Tailwind: `bg-slate-900`, `border-slate-800`)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ loading/error —Å–æ—Å—Ç–æ—è–Ω–∏–π
- Responsive –¥–∏–∑–∞–π–Ω (mobile-first)

---

## –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### –ü–æ—Ç–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É (/register)
   ‚Üì
2. POST /auth/register
   {
     email, username, password, full_name
   }
   ‚Üì
3. Backend:
   - –•–µ—à–∏—Ä—É–µ—Ç –ø–∞—Ä–æ–ª—å (bcrypt)
   - –°–æ–∑–¥–∞–µ—Ç User –≤ –ë–î
   - –°–æ–∑–¥–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π AthleteProfileDB
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT —Ç–æ–∫–µ–Ω
   ‚Üì
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
   {
     access_token: "eyJ...",
     token_type: "bearer",
     user: { id, email, username, ... }
   }
   ‚Üì
5. Frontend —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω –≤ localStorage
   ‚Üì
6. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /onboarding –∏–ª–∏ /dashboard
```

### –ü–æ—Ç–æ–∫ –≤—Ö–æ–¥–∞

```
1. POST /auth/login
   {
     email, password
   }
   ‚Üì
2. Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞—Ä–æ–ª—å (bcrypt.verify)
   ‚Üì
3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT —Ç–æ–∫–µ–Ω
   ‚Üì
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω + user
   ‚Üì
5. Frontend —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ localStorage
```

### JWT Token Structure

```json
{
  "sub": 123,  // user_id
  "exp": 1234567890,  // expiration timestamp
  "iat": 1234567890   // issued at
}
```

**–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á:** `SECRET_KEY` –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –ó–∞—â–∏—Ç–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

```python
@app.get("/profile")
async def get_profile(
    current_user: models.User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # current_user –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞
    profile = db.query(models.AthleteProfileDB).filter(
        models.AthleteProfileDB.user_id == current_user.id
    ).first()
    return profile
```

### Strava OAuth Flow

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "Connect Strava" (/coach)
   ‚Üì
2. Frontend —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç URL:
   GET /auth/strava/login?state={base64_encoded_jwt}
   (state —Å–æ–¥–µ—Ä–∂–∏—Ç JWT —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
   ‚Üì
3. Backend —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ Strava:
   https://www.strava.com/oauth/authorize?
     client_id=...
     &redirect_uri=...
     &state={jwt_token}
   ‚Üì
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –≤ Strava
   ‚Üì
5. Strava —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞:
   GET /auth/strava/callback?code=...&state={jwt_token}
   ‚Üì
6. Backend:
   - –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç state ‚Üí –ø–æ–ª—É—á–∞–µ—Ç user_id
   - –û–±–º–µ–Ω–∏–≤–∞–µ—Ç code –Ω–∞ access/refresh —Ç–æ–∫–µ–Ω—ã
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω—ã –≤ User.strava_* –ø–æ–ª—è
   ‚Üì
7. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML —Å —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º –Ω–∞ /coach
```

**–í–∞–∂–Ω–æ:** `state` –ø–∞—Ä–∞–º–µ—Ç—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç.–∫. –≤ OAuth callback –Ω–µ—Ç `Authorization` –∑–∞–≥–æ–ª–æ–≤–∫–∞.

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 1. Strava API

**OAuth 2.0 Flow:**
- Authorization Code Grant
- Scopes: `read`, `activity:read_all`
- Refresh token –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è access token

**–û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã Strava:**
- `GET /athlete/activities` ‚Äî —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
- `GET /activities/{id}` ‚Äî –¥–µ—Ç–∞–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- `GET /segments/{id}` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ–≥–º–µ–Ω—Ç–µ
- `GET /segments/explore` ‚Äî –ø–æ–∏—Å–∫ —Å–µ–≥–º–µ–Ω—Ç–æ–≤

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `strava_client.py`

### 2. OpenAI GPT

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ú–æ–¥–µ–ª—å: `gpt-4o` (–∏–ª–∏ `gpt-4-turbo`)
- JSON mode –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- System prompt –≤ `prompts/trainer_prompt.py`

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ–¥–µ–ª—å–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
- Initial assessment
- –ü—Ä–æ–≥–Ω–æ–∑—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `coach.py`, `performance_predictions.py`

### 3. Email (Resend)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ–¥–µ–ª—å–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
- –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–æ–≤
- –≠–∫—Å–ø–æ—Ä—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π (.ics)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `email_resend.py`

---

## –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞

```
Frontend: POST /coach/plan
  ‚Üì
Backend:
  1. –ü–æ–ª—É—á–∞–µ—Ç primary goal –∏–∑ –ë–î
  2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –∞—Ç–ª–µ—Ç–∞
  3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –Ω–µ–¥–µ–ª—å –∏–∑ Strava
  4. –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è GPT
  5. –í—ã–∑—ã–≤–∞–µ—Ç OpenAI API
  6. –ü–∞—Ä—Å–∏—Ç JSON –æ—Ç–≤–µ—Ç
  7. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–ª–∞–Ω –≤ WeeklyPlanDB
  8. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–ª–∞–Ω
  ‚Üì
Frontend: –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–ª–∞–Ω –Ω–∞ /dashboard
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –∑–æ–Ω

```
Frontend: POST /zones/calculate?activity_type=run
  ‚Üì
Backend:
  1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–∑ Strava
  2. –ò—â–µ—Ç –ª—É—á—à–∏–µ —É—Å–∏–ª–∏—è (5K, 10K, HM, Marathon)
  3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∑–æ–Ω—ã –ø–æ —Ñ–æ—Ä–º—É–ª–∞–º (VDOT, etc.)
  4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ AthleteProfileDB.training_zones_run
  5. –û–±–Ω–æ–≤–ª—è–µ—Ç JSON –ø—Ä–æ—Ñ–∏–ª—å (legacy)
  6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–æ–Ω—ã
  ‚Üì
Frontend: –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∑–æ–Ω—ã –Ω–∞ /dashboard
```

### 3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π Strava

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç Strava
  ‚Üì
Backend —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω—ã –≤ User
  ‚Üì
–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π:
  1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞
  2. –ï—Å–ª–∏ –∏—Å—Ç–µ–∫ ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ refresh_token
  3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–∑ Strava API
  4. –ö—ç—à–∏—Ä—É–µ—Ç –≤ ActivityDB
  5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
```

### 4. –ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–∞ —Ç—Ä–∞–≤–º

```
Frontend: GET /analytics/injury_risk
  ‚Üì
Backend:
  1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4-8 –Ω–µ–¥–µ–ª—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
  2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç:
     - –†–µ–∑–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ–±—ä–µ–º–∞
     - –ß–∞—Å—Ç–æ—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
     - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ–∂–¥—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏
     - –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
  3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç risk_score (0-100)
  4. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç risk_level (low/moderate/high)
  5. –§–æ—Ä–º–∏—Ä—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
  6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  ‚Üì
Frontend: –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤ InjuryRiskCard
```

---

## –î–µ–ø–ª–æ–π –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### Railway Deployment

**Backend Service:**
- **Build Command**: `pip install -r requirements.txt`
- **Start Command**: `uvicorn main:app --host 0.0.0.0 --port $PORT`
- **Environment Variables**:
  - `DATABASE_URL` (PostgreSQL)
  - `SECRET_KEY`
  - `OPENAI_API_KEY`
  - `STRAVA_CLIENT_ID`, `STRAVA_CLIENT_SECRET`, `STRAVA_REDIRECT_URI`
  - `FRONTEND_BASE_URL`

**Frontend Service:**
- **Build Command**: `npm install && npm run build`
- **Start Command**: `npm start`
- **Root Directory**: `frontend/`
- **Nixpacks Config**: `frontend/nixpacks.toml` (Node.js 20)

### GitHub Actions CI/CD

```yaml
# .github/workflows/ci.yml
- name: Deploy backend
  run: |
    railway link --service backend
    railway up --service backend

- name: Deploy frontend
  run: |
    railway link --service frontend
    railway up --service frontend
```

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- Push –≤ `main` –≤–µ—Ç–∫—É
- Pull request (—Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã)

### Database Migrations

**Production:**
```bash
# –ù–∞ Railway —á–µ—Ä–µ–∑ CLI –∏–ª–∏ –≤—Ä—É—á–Ω—É—é
alembic upgrade head
```

**Development:**
```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (init_db)
# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
alembic upgrade head
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

- **JWT —Ç–æ–∫–µ–Ω—ã** —Å expiration (24 —á–∞—Å–∞)
- **Bcrypt** –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
- **HTTPS only** –≤ production

### 2. CORS

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=[...],  # –¢–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã
    allow_origin_regex=r"https://.*\.up\.railway\.app",
    allow_credentials=True,
)
```

### 3. Rate Limiting

```python
from slowapi import Limiter

limiter = Limiter(key_func=get_remote_address)

@app.post("/coach/plan")
@limiter.limit("10/minute")
async def generate_plan(...):
    ...
```

### 4. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

- **Pydantic** —Å—Ö–µ–º—ã –¥–ª—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **SQLAlchemy** –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç SQL injection
- **Type checking** –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (TypeScript)

### 5. Secrets Management

- –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ù–µ –∫–æ–º–º–∏—Ç—è—Ç—Å—è –≤ Git
- –£–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Railway dashboard

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:

- **Backend**: FastAPI + SQLAlchemy + JWT
- **Frontend**: Next.js + React Query + TypeScript
- **Database**: SQLite (dev) / PostgreSQL (prod)
- **Deployment**: Railway + GitHub Actions

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-09
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** 1.0

